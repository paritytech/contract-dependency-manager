name: Deploy Frontend

on:
    push:
        branches:
            - main
    pull_request:
        branches:
            - main
    workflow_dispatch:
        inputs:
            skip-cache:
                description: "Skip deployment cache and force redeploy"
                type: boolean
                default: false

permissions:
    contents: read
    statuses: write
    id-token: write
    pull-requests: write

concurrency:
    group: deploy-frontend-${{ github.event.pull_request.number || github.ref }}
    cancel-in-progress: true

jobs:
    build:
        runs-on: ubuntu-latest
        name: Build
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Setup pnpm
              uses: pnpm/action-setup@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "22"

            - name: Install and build
              run: pnpm install && pnpm turbo build --filter=@dotdm/frontend

            - name: Upload build artifact
              uses: actions/upload-artifact@v4
              with:
                  name: frontend-build
                  path: src/apps/frontend/dist
                  retention-days: 1

    comment-deploying:
        needs: build
        if: github.event_name == 'pull_request'
        runs-on: ubuntu-latest
        name: Comment Deploying
        steps:
            - name: Comment deployment in progress
              uses: marocchino/sticky-pull-request-comment@v2
              with:
                  header: deploy-preview
                  message: |
                      ## Preview Deployment

                      | App | Status |
                      |:---:|:------:|
                      | Frontend | Deploying... |

                      <sub>Deployment in progress. This comment will update when ready. [View workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})</sub>

    deploy:
        needs: build
        name: Deploy
        uses: paritytech/dotns-sdk/.github/workflows/deploy.yml@main
        with:
            basename: contracts
            mode: ${{ (github.event_name == 'push' || github.event_name == 'workflow_dispatch') && 'production' || 'preview' }}
            artifact-name: frontend-build
            register-base: true
            skip-cache: ${{ inputs.skip-cache || false }}
            max-retries: 3
        secrets:
            dotns-mnemonic: ${{ secrets.MNEMONIC }}

    comment-success:
        needs: [build, deploy]
        if: github.event_name == 'pull_request' && success()
        runs-on: ubuntu-latest
        name: Comment Success
        steps:
            - name: Comment on PR
              uses: marocchino/sticky-pull-request-comment@v2
              with:
                  header: deploy-preview
                  message: |
                      ## Preview Deployment Ready!

                      | App | Status | Preview |
                      |:---:|:------:|:-------:|
                      | **Frontend** | Ready | [**Visit Preview**](${{ needs.deploy.outputs.url }}) |

                      <details>
                      <summary>Deployment Details</summary>

                      | Detail | Value |
                      |--------|-------|
                      | **Domain** | `${{ needs.deploy.outputs.fqdn }}` |
                      | **CID** | `${{ needs.deploy.outputs.cid }}` |
                      | **Commit** | [`${{ github.event.pull_request.head.sha }}`](${{ github.event.pull_request.head.repo.html_url }}/commit/${{ github.event.pull_request.head.sha }}) |
                      | **Branch** | `${{ github.head_ref }}` |

                      </details>

                      ---
                      <sub>This preview updates automatically on each push to this PR. [View workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})</sub>

    comment-failure:
        needs: [build, deploy]
        if: github.event_name == 'pull_request' && failure()
        runs-on: ubuntu-latest
        name: Comment Failure
        steps:
            - name: Comment on PR
              uses: marocchino/sticky-pull-request-comment@v2
              with:
                  header: deploy-preview
                  message: |
                      ## Preview Deployment Failed

                      | Stage | Status |
                      |:------|:------:|
                      | **Build** | ${{ needs.build.result == 'success' && 'Built' || needs.build.result == 'skipped' && 'Skipped' || 'Failed' }} |
                      | **Deploy** | ${{ needs.deploy.result == 'success' && 'Deployed' || needs.deploy.result == 'skipped' && 'Skipped' || 'Failed' }} |

                      [**View workflow run**](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

                      ---
                      <sub>Fix any issues and push again to retry.</sub>
