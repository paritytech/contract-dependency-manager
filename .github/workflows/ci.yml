name: CI

# on:
#     push:
#         branches: [main]
#     pull_request:
#         branches: [main]
on: workflow_dispatch

env:
    BIN: ${{ github.workspace }}/bin
    SCRIPTS: ${{ github.workspace }}/scripts
    ZOMBIE_DIR: /tmp/zombie-test

jobs:
    test:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
            - uses: oven-sh/setup-bun@v2
            - uses: pnpm/action-setup@v4
              with:
                  version: 9
            - uses: actions/setup-node@v4
              with:
                  node-version: '22'
                  cache: 'pnpm'
            - name: Setup
              run: make setup
            - name: Start network
              run: |
                  BIN=$(realpath ppn/bin) SCRIPTS=$(realpath ppn/scripts) \
                    ppn/bin/zombie-cli spawn -p native -d ${{ env.ZOMBIE_DIR }} \
                    ppn/zombienet-configs/local-dev.toml & \
                    echo "Waiting for network to start..."

                  # Wait for network to be ready (check for zombie.json)
                  echo "Waiting for network to start..."
                  for i in {1..60}; do
                      if [ -f "${{ env.ZOMBIE_DIR }}/zombie.json" ]; then
                      echo "Network started, zombie.json found"
                      break
                      fi
                      sleep 10
                  done

                  # Additional wait for nodes to be ready
                  sleep 30
            - name: Run tests
              run: |
                  pnpm install
                  bun test src/apps/cli/tests/
                  bun test src/apps/cli/tests/e2e.test.ts
